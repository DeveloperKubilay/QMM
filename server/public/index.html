<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QMM Admin Panel</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e1e1e;
            color: #d4d4d4;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        h1 { margin-bottom: 20px; color: #569cd6; }
        .card {
            background-color: #252526;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }
        input, select, button {
            background-color: #3c3c3c;
            border: 1px solid #555;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 5px 0;
        }
        button {
            cursor: pointer;
            background-color: #0e639c;
            border: none;
        }
        button:hover { background-color: #1177bb; }
        button.delete-btn {
            background-color: #ce3838;
        }
        button.delete-btn:hover { background-color: #e54b4b; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid #3c3c3c;
        }
        th { color: #9cdcfe; }
        .status { margin-bottom: 10px; font-weight: bold; }
        .error { color: #f48771; }
        .success { color: #89d185; }
    </style>
</head>
<body>

<div class="container">
    <h1>QMM - GÃ¼venli Makine YÃ¶netimi ðŸ”’</h1>
    
    <div class="status" id="statusMessage">HoÅŸgeldiniz. API AnahtarÄ± bekleniyor...</div>

    <!-- Ekleme Formu -->
    <div class="card">
        <h3>Yeni Sunucu Ekle</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
            <input type="text" id="name" placeholder="Sunucu AdÄ± (Ã–rn: Web01)">
            <select id="protocol">
                <option value="ssh">SSH</option>
                <option value="rdp">RDP</option>
                <option value="https">HTTPS</option>
            </select>
            <input type="text" id="address" placeholder="IP Adresi (192.168.1.5)">
            <input type="text" id="username" placeholder="KullanÄ±cÄ± AdÄ±">
            <input type="password" id="password" placeholder="Åžifre">
            <input type="number" id="port" value="22" placeholder="Port">
        </div>
        <div style="margin-top: 10px; text-align: right;">
            <button onclick="addHost()">Ekle âž•</button>
        </div>
    </div>

    <!-- Liste -->
    <div class="card">
        <h3>BaÄŸlÄ± Sunucular</h3>
        <button onclick="fetchHosts()" style="margin-bottom: 10px;">Yenile ðŸ”„</button>
        <table id="hostTable">
            <thead>
                <tr>
                    <th>Ad</th>
                    <th>Protokol</th>
                    <th>IP Adresi</th>
                    <th>KullanÄ±cÄ±</th>
                    <th>Port</th>
                    <th>Ä°ÅŸlem</th>
                </tr>
            </thead>
            <tbody>
                <!-- Veriler buraya gelecek -->
            </tbody>
        </table>
    </div>
</div>

<script>
    const API_URL = '/api/hosts';
    let apiKey = localStorage.getItem('qmm_api_key');

    function promptApiKey() {
        const key = prompt("LÃ¼tfen Admin API AnahtarÄ±nÄ± girin:", apiKey || "");
        if (key) {
            apiKey = key;
            localStorage.setItem('qmm_api_key', key);
            fetchHosts();
        } else {
            showStatus("API AnahtarÄ± girilmedi.", "error");
        }
    }

    function showStatus(msg, type = 'normal') {
        const el = document.getElementById('statusMessage');
        el.innerText = msg;
        el.className = 'status ' + type;
        console.log(`[${type}] ${msg}`);
    }

    async function fetchHosts() {
        if (!apiKey) return promptApiKey();

        try {
            const res = await fetch(API_URL, {
                headers: { 'x-api-key': apiKey }
            });
            
            if (res.status === 403) {
                localStorage.removeItem('qmm_api_key');
                showStatus("API AnahtarÄ± geÃ§ersiz!", "error");
                apiKey = null;
                setTimeout(promptApiKey, 1000);
                return;
            }

            const data = await res.json();
            renderTable(data);
            showStatus("Veriler yÃ¼klendi.", "success");
        } catch (err) {
            showStatus("Sunucuya baÄŸlanÄ±lamadÄ±: " + err.message, "error");
        }
    }

    function renderTable(hosts) {
        const tbody = document.querySelector('#hostTable tbody');
        tbody.innerHTML = '';
        
        hosts.forEach(host => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${host.name}</td>
                <td><span style="background:#0e639c; padding:2px 6px; border-radius:4px; font-size:0.8em;">${host.protocol}</span></td>
                <td>${host.address}</td>
                <td>${host.username}</td>
                <td>${host.port}</td>
                <td>
                    <button class="delete-btn" onclick="deleteHost(${host.id})">Sil</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function addHost() {
        if (!apiKey) return promptApiKey();

        const host = {
            name: document.getElementById('name').value,
            protocol: document.getElementById('protocol').value,
            address: document.getElementById('address').value,
            username: document.getElementById('username').value,
            password: document.getElementById('password').value,
            port: document.getElementById('port').value,
        };

        if (!host.address || !host.username) {
            showStatus("LÃ¼tfen gerekli alanlarÄ± doldurun.", "error");
            return;
        }

        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey
                },
                body: JSON.stringify(host)
            });

            if (res.ok) {
                showStatus("Host eklendi!", "success");
                // Temizle
                document.getElementById('name').value = '';
                document.getElementById('address').value = '';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                fetchHosts();
            } else {
                const err = await res.json();
                showStatus("Hata: " + err.error, "error");
            }
        } catch (error) {
            showStatus("Ekleme baÅŸarÄ±sÄ±z.", "error");
        }
    }

    async function deleteHost(id) {
        if (!confirm("Bu hostu silmek istediÄŸinize emin misiniz?")) return;

        try {
            const res = await fetch(`${API_URL}/${id}`, {
                method: 'DELETE',
                headers: { 'x-api-key': apiKey }
            });

            if (res.ok) {
                showStatus("Host silindi.", "success");
                fetchHosts();
            } else {
                showStatus("Silme hatasÄ±.", "error");
            }
        } catch (error) {
            showStatus("BaÄŸlantÄ± hatasÄ±.", "error");
        }
    }

    // BaÅŸlangÄ±Ã§ta Ã§alÄ±ÅŸtÄ±r
    if (apiKey) {
        fetchHosts();
    } else {
        setTimeout(promptApiKey, 500);
    }
</script>

</body>
</html>
